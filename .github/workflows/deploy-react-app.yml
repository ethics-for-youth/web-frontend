name: Deploy React App to S3

on:
  push:
    paths:
      - 'src/**'     # Common React app paths
      - 'public/**'
      - 'package.json'
    branches:
      - develop
      - qa
  workflow_dispatch:  # Allow manual triggering
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - qa
      force_deploy:
        description: 'Force deployment even if no changes in build output'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-south-1
  NODE_VERSION: '18'

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          # Determine environment based on branch or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/qa" ]; then
            ENVIRONMENT="qa"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENVIRONMENT="develop"
          else
            echo "âŒ No environment mapping for branch: ${{ github.ref }}"
            exit 1
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Deploying to environment: $ENVIRONMENT"

  build-and-deploy:
    needs: determine-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      id-token: write
      contents: read
      actions: read
    
    steps:
      - name: Get environment variables
        id: env-vars
        run: |
          # Get environment-specific configurations from GitHub Environment
          S3_BUCKET="${{ vars.S3_BUCKET }}"
          
          # Validate required variables
          if [ -z "$S3_BUCKET" ]; then
            echo "âŒ S3_BUCKET not configured in GitHub Environment: ${{ needs.determine-environment.outputs.environment }}"
            exit 1
          fi
          
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ S3 Bucket: $S3_BUCKET"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to compare changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm i

      - name: Set environment variables
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          # Set API base URL based on environment
          case $ENVIRONMENT in
            "develop")
              API_BASE_URL="https://dev.efy.org.in/api"
              ;;
            "qa")
              API_BASE_URL="https://qa.efy.org.in/api"
              ;;
            "production")
              API_BASE_URL="https://efy.org.in/api"
              ;;
            *)
              echo "âŒ Unknown environment: $ENVIRONMENT"
              exit 1
              ;;
          esac
          
          # Create runtime environment file
          cat > .env << EOF
          VITE_API_BASE_URL=$API_BASE_URL
          VITE_ENVIRONMENT=$ENVIRONMENT
          VITE_VERSION=${{ github.sha }}
          VITE_BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VITE_API_TIMEOUT=10000
          VITE_API_LOGGING=$( [ "$ENVIRONMENT" = "develop" ] && echo "true" || echo "false" )
          EOF
          
          echo "âœ… Environment variables set for $ENVIRONMENT"
          echo "ðŸ“‹ API Base URL: $API_BASE_URL"

      - name: Build React application
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸ—ï¸ Building React application for $ENVIRONMENT..."
          
          # Use appropriate build script based on environment
          case $ENVIRONMENT in
            "develop")
              npm run build:dev
              ;;
            "qa")
              npm run build:qa
              ;;
            "production")
              npm run build:prod
              ;;
            *)
              npm run build
              ;;
          esac
          
          # Verify build output
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          
          echo "ðŸ“Š Build output size:"
          du -sh dist/
          
          echo "ðŸ“‹ Build contents:"
          find dist -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10

      - name: Check for deployment changes
        id: check_changes
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          # Create hash of current build
          CURRENT_HASH=$(find dist -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "current_build_hash=$CURRENT_HASH" >> $GITHUB_OUTPUT
          
          # Check if we should deploy
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Force deployment requested"
          else
            # Check if build hash changed
            PREVIOUS_HASH=$(aws s3 cp s3://$S3_BUCKET/.build-hash - 2>/dev/null || echo "")
            if [ "$CURRENT_HASH" != "$PREVIOUS_HASH" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "ðŸ“‹ Build hash changed: $PREVIOUS_HASH -> $CURRENT_HASH"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "âœ… No changes detected in build output"
            fi
          fi

      - name: Get S3 bucket URL
        id: get-url
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          # Get bucket website URL
          BUCKET_WEBSITE_URL="http://$S3_BUCKET.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          echo "website_url=$BUCKET_WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Website URL: $BUCKET_WEBSITE_URL"

      - name: Backup current deployment
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "ðŸ’¾ Creating backup of current deployment..."
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          
          # Create backup by copying current S3 content to backup prefix
          aws s3 sync s3://$S3_BUCKET/ s3://$S3_BUCKET/backups/$ENVIRONMENT/$TIMESTAMP/ \
            --exclude "backups/*" \
            --quiet || echo "No existing deployment to backup"
          
          echo "backup_timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "âœ… Backup created: backups/$ENVIRONMENT/$TIMESTAMP"
        id: backup

      - name: Deploy to S3
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "ðŸš€ Deploying to S3 bucket: $S3_BUCKET (Environment: $ENVIRONMENT)"
          ls -al dist/
          
          # Sync build directory to S3 with proper cache headers
          aws s3 sync dist/ s3://$S3_BUCKET/ \
            --delete \
            --cache-control "max-age=31536000" \
            --exclude "*.html" \
            --exclude "service-worker.js" \
            --exclude "manifest.json"
          
          # Upload HTML files with no-cache headers
          aws s3 sync dist/ s3://$S3_BUCKET/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "service-worker.js"
          
          # Upload manifest with short cache
          aws s3 sync dist/ s3://$S3_BUCKET/ \
            --cache-control "max-age=300" \
            --include "manifest.json"
          
          # Store build hash for future comparisons
          echo "${{ steps.check_changes.outputs.current_build_hash }}" | aws s3 cp - s3://$S3_BUCKET/.build-hash
          
          echo "âœ… Deployment to S3 completed"

      - name: Set S3 bucket website configuration
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          
          echo "ðŸŒ Configuring S3 bucket for static website hosting..."
          
          # Create website configuration
          cat > website-config.json << EOF
          {
            "IndexDocument": {
              "Suffix": "index.html"
            },
            "ErrorDocument": {
              "Key": "index.html"
            }
          }
          EOF
          
          # Apply website configuration
          aws s3api put-bucket-website \
            --bucket $S3_BUCKET \
            --website-configuration file://website-config.json
          
          echo "âœ… S3 website configuration applied"

      - name: Run post-deployment tests
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "ðŸ§ª Running post-deployment tests for $ENVIRONMENT..."
          
          # Wait a moment for propagation
          sleep 10
          
          # Test website accessibility
          WEBSITE_URL="${{ steps.get-url.outputs.website_url }}"
          
          echo "Testing website: $WEBSITE_URL"
          
          # Test main page
          if curl -f -s --max-time 30 "$WEBSITE_URL" > /dev/null; then
            echo "âœ… Website is accessible"
          else
            echo "âŒ Website is not accessible"
            exit 1
          fi
          
          # Test React app is loaded (check for root div)
          if curl -s --max-time 30 "$WEBSITE_URL" | grep -q 'id="root"'; then
            echo "âœ… React app structure detected"
          else
            echo "âš ï¸ React app structure not detected (might be OK for some setups)"
          fi

      - name: Store deployment metadata
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          # Create deployment metadata
          cat > deployment-info.json << EOF
          {
            "deployment_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "$ENVIRONMENT",
            "commit_sha": "${{ github.sha }}",
            "commit_message": $(echo '${{ github.event.head_commit.message }}' | jq -R .),
            "build_hash": "${{ steps.check_changes.outputs.current_build_hash }}",
            "backup_timestamp": "${{ steps.backup.outputs.backup_timestamp }}",
            "website_url": "${{ steps.get-url.outputs.website_url }}",
            "triggered_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF
          
          # Upload metadata to S3
          aws s3 cp deployment-info.json s3://$S3_BUCKET/.deployment-info.json \
            --cache-control "no-cache"
          
          echo "ðŸ“‹ Deployment metadata stored"

      - name: Deployment success notification
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          
          echo "ðŸŽ‰ React app deployment to $ENVIRONMENT completed successfully!"
          echo ""
          echo "ðŸ“Š Deployment Summary:"
          echo "â”œâ”€â”€ Environment: $ENVIRONMENT"
          echo "â”œâ”€â”€ Website URL: ${{ steps.get-url.outputs.website_url }}"
          echo "â”œâ”€â”€ Build Hash: ${{ steps.check_changes.outputs.current_build_hash }}"
          echo "â”œâ”€â”€ Backup: backups/$ENVIRONMENT/${{ steps.backup.outputs.backup_timestamp }}"
          echo "â”œâ”€â”€ Commit: ${{ github.sha }}"
          echo "â””â”€â”€ Deployed by: ${{ github.actor }}"

      - name: No changes detected
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          echo "âœ… No changes detected in build output for $ENVIRONMENT. Skipping deployment."
          echo "Current build hash: ${{ steps.check_changes.outputs.current_build_hash }}"
          echo "Use 'force_deploy' option if you want to deploy anyway."

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: react-build-${{ needs.determine-environment.outputs.environment }}-${{ github.run_number }}
          path: |
            dist/
            deployment-info.json
          retention-days: 7

      - name: Rollback on failure
        if: failure() && steps.check_changes.outputs.has_changes == 'true' && steps.backup.outputs.backup_timestamp != ''
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "ðŸ’¥ Deployment failed! Initiating rollback..."
          
          # Restore from backup
          BACKUP_PATH="backups/$ENVIRONMENT/${{ steps.backup.outputs.backup_timestamp }}"
          echo "ðŸ“‹ Restoring from: $BACKUP_PATH"
          
          aws s3 sync s3://$S3_BUCKET/$BACKUP_PATH/ s3://$S3_BUCKET/ \
            --delete \
            --exclude "backups/*" \
            --exclude ".deployment-info.json"
          
          echo "âœ… Rollback completed for $ENVIRONMENT"

      - name: Cleanup old backups
        if: always()
        run: |
          S3_BUCKET="${{ steps.env-vars.outputs.s3_bucket }}"
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "ðŸ§¹ Cleaning up old backups for $ENVIRONMENT (keeping last 5)..."
          
          # List backups for this environment and keep only the 5 most recent
          aws s3 ls s3://$S3_BUCKET/backups/$ENVIRONMENT/ | sort -r | tail -n +6 | while read -r line; do
            BACKUP_DIR=$(echo $line | awk '{print $2}')
            if [ -n "$BACKUP_DIR" ]; then
              echo "Deleting old backup: $BACKUP_DIR"
              aws s3 rm s3://$S3_BUCKET/backups/$ENVIRONMENT/$BACKUP_DIR --recursive --quiet
            fi
          done || echo "No old backups to clean"
